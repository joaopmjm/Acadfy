"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const mongoose_1 = require("mongoose");
const di_1 = require("@decorators/di");
const meta_1 = require("./meta");
/**
 * Quick helper function to link reference
 *
 * @param {String} collectionRef
 *
 * @returns { {type: "mongoose".Schema.Types.ObjectId, ref: string} }
 */
function ref(collectionRef) {
    return { type: mongoose_1.Schema.Types.ObjectId, ref: collectionRef };
}
exports.ref = ref;
/**
 * Create mongoose schema out of @decorators/mongoose class
 *
 * @param {MongooseClass} modelClass
 *
 * @returns {Object} Mongoose model itself
 */
function schema(modelClass) {
    const { meta, instance } = getArtifacts(modelClass);
    return buildSchema(meta, instance);
}
exports.schema = schema;
/**
 * Create mongoose model out of @decorators/mongoose class
 *
 * @param {MongooseClass} modelClass
 *
 * @returns {Object} Mongoose model itself
 */
function model(modelClass) {
    const { meta, instance } = getArtifacts(modelClass);
    const statics = {};
    meta.statics.forEach((stat) => {
        if (typeof stat[1] !== 'function') {
            statics[stat] = modelClass[stat];
        }
    });
    const newModel = mongoose_1.model(meta.name, buildSchema(meta, instance));
    /**
     * Extend model with statics
     */
    for (let key of Object.keys(statics)) {
        newModel[key] = statics[key];
    }
    return newModel;
}
exports.model = model;
/**
 * Build schema
 *
 * @param {MongooseMeta} meta
 * @param {any} classInstance
 *
 * @returns {Schema}
 */
function buildSchema(meta, classInstance) {
    let newSchema = new mongoose_1.Schema(meta.schema);
    let indexes = {};
    meta.statics.forEach((stat) => {
        if (typeof stat[1] === 'function') {
            newSchema.statics[stat[0]] = wrapFunction(stat[1], classInstance);
        }
    });
    meta.queries.forEach(([name, fn]) => {
        newSchema['query'][name] = wrapFunction(fn, classInstance);
    });
    meta.instances.forEach(([name, fn]) => {
        newSchema.methods[name] = wrapFunction(fn, classInstance);
    });
    meta.virtuals.forEach(([name, descriptor]) => {
        const virtual = newSchema.virtual(name);
        if (descriptor.get) {
            virtual.get(wrapFunction(descriptor.get, classInstance));
        }
        if (descriptor.set) {
            virtual.set(wrapFunction(descriptor.set, classInstance));
        }
    });
    meta.indexes.forEach((index) => {
        indexes[index] = classInstance[index];
        newSchema.index({ [index]: classInstance[index] });
    });
    // newSchema.index(indexes);
    meta.options.forEach(([option, value]) => {
        newSchema.set(option, value);
    });
    meta.hooks.forEach(([hookType, actionType, name]) => {
        newSchema[hookType](actionType, function (next) {
            /**
             * Hook expects to get exactly one parameter, so
             * wrapped function cannot be passed as an argument
             */
            return wrapFunction(classInstance[name], classInstance).call(this, next);
        });
    });
    return newSchema;
}
/**
 * Wrap function with correct context just to make sure,
 * that functions will be executed with scope of class
 * in order to get DI working properly
 *
 * @param {Function} fn
 * @param {any} instance
 *
 * @returns {Function}
 */
function wrapFunction(fn, instance) {
    return function (next) {
        let fullCtx = instance;
        if (this) {
            fullCtx = Object.assign({}, instance, (this || {}));
            Object.setPrototypeOf(fullCtx, Object.getPrototypeOf(this));
        }
        return fn.apply(fullCtx, [next]);
    };
}
/**
 * Extract meta and classInstance of the injectable
 *
 * @param {MongooseClass} modelClass
 *
 * @returns {{ meta: MongooseMeta, instance: MongooseClass }}
 */
function getArtifacts(modelClass) {
    const instance = getModel(modelClass);
    const meta = meta_1.getMongooseMeta(instance);
    return { meta, instance };
}
/**
 * Get model instance from container or instantiate one
 *
 * @param {MongooseClass} ModelClass
 *
 * @returns {MongooseClass}
 */
function getModel(ModelClass) {
    try {
        return di_1.Container.get(ModelClass);
    }
    catch (_a) {
        return new ModelClass();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9uZ29vc2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvbW9uZ29vc2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSx1Q0FBMEQ7QUFDMUQsdUNBQTJDO0FBRTNDLGlDQUEwRTtBQUUxRTs7Ozs7O0dBTUc7QUFDSCxhQUFvQixhQUFxQjtJQUN2QyxNQUFNLENBQUMsRUFBRSxJQUFJLEVBQUUsaUJBQU0sQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLEdBQUcsRUFBRSxhQUFhLEVBQUUsQ0FBQztBQUM3RCxDQUFDO0FBRkQsa0JBRUM7QUFFRDs7Ozs7O0dBTUc7QUFDSCxnQkFBdUIsVUFBeUI7SUFDOUMsTUFBTSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsR0FBRyxZQUFZLENBQUMsVUFBVSxDQUFDLENBQUM7SUFFcEQsTUFBTSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7QUFDckMsQ0FBQztBQUpELHdCQUlDO0FBRUQ7Ozs7OztHQU1HO0FBQ0gsZUFBeUIsVUFBeUI7SUFDaEQsTUFBTSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsR0FBRyxZQUFZLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDcEQsTUFBTSxPQUFPLEdBQUcsRUFBRSxDQUFDO0lBRW5CLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBMkIsRUFBRSxFQUFFO1FBQ25ELEVBQUUsQ0FBQyxDQUFDLE9BQU8sSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLFVBQVUsQ0FBQyxDQUFDLENBQUM7WUFDbEMsT0FBTyxDQUFTLElBQUksQ0FBQyxHQUFHLFVBQVUsQ0FBUyxJQUFJLENBQUMsQ0FBQztRQUNuRCxDQUFDO0lBQ0gsQ0FBQyxDQUFDLENBQUM7SUFFSCxNQUFNLFFBQVEsR0FBRyxnQkFBYSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsV0FBVyxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDO0lB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LElBQUksQ0FBQztRQUNILE1BQU0sQ0FBQyxjQUFTLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ25DLENBQUM7SUFBQyxLQUFLLENBQUMsQ0FBQyxJQUFELENBQUM7UUFDUCxNQUFNLENBQUMsSUFBSSxVQUFVLEVBQUUsQ0FBQztJQUMxQixDQUFDO0FBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFNjaGVtYSwgbW9kZWwgYXMgTW9uZ29vc2VNb2RlbCB9IGZyb20gJ21vbmdvb3NlJztcbmltcG9ydCB7IENvbnRhaW5lciB9IGZyb20gJ0BkZWNvcmF0b3JzL2RpJztcblxuaW1wb3J0IHsgZ2V0TW9uZ29vc2VNZXRhLCBGbiwgTW9uZ29vc2VDbGFzcywgTW9uZ29vc2VNZXRhIH0gZnJvbSAnLi9tZXRhJztcblxuLyoqXG4gKiBRdWljayBoZWxwZXIgZnVuY3Rpb24gdG8gbGluayByZWZlcmVuY2VcbiAqXG4gKiBAcGFyYW0ge1N0cmluZ30gY29sbGVjdGlvblJlZlxuICpcbiAqIEByZXR1cm5zIHsge3R5cGU6IFwibW9uZ29vc2VcIi5TY2hlbWEuVHlwZXMuT2JqZWN0SWQsIHJlZjogc3RyaW5nfSB9XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiByZWYoY29sbGVjdGlvblJlZjogc3RyaW5nKTogeyB0eXBlOiBhbnksIHJlZjogc3RyaW5nIH0ge1xuICByZXR1cm4geyB0eXBlOiBTY2hlbWEuVHlwZXMuT2JqZWN0SWQsIHJlZjogY29sbGVjdGlvblJlZiB9O1xufVxuXG4vKipcbiAqIENyZWF0ZSBtb25nb29zZSBzY2hlbWEgb3V0IG9mIEBkZWNvcmF0b3JzL21vbmdvb3NlIGNsYXNzXG4gKlxuICogQHBhcmFtIHtNb25nb29zZUNsYXNzfSBtb2RlbENsYXNzXG4gKlxuICogQHJldHVybnMge09iamVjdH0gTW9uZ29vc2UgbW9kZWwgaXRzZWxmXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBzY2hlbWEobW9kZWxDbGFzczogTW9uZ29vc2VDbGFzcyk6IFNjaGVtYSB7XG4gIGNvbnN0IHsgbWV0YSwgaW5zdGFuY2UgfSA9IGdldEFydGlmYWN0cyhtb2RlbENsYXNzKTtcblxuICByZXR1cm4gYnVpbGRTY2hlbWEobWV0YSwgaW5zdGFuY2UpO1xufVxuXG4vKipcbiAqIENyZWF0ZSBtb25nb29zZSBtb2RlbCBvdXQgb2YgQGRlY29yYXRvcnMvbW9uZ29vc2UgY2xhc3NcbiAqXG4gKiBAcGFyYW0ge01vbmdvb3NlQ2xhc3N9IG1vZGVsQ2xhc3NcbiAqXG4gKiBAcmV0dXJucyB7T2JqZWN0fSBNb25nb29zZSBtb2RlbCBpdHNlbGZcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIG1vZGVsPFQ+KG1vZGVsQ2xhc3M6IE1vbmdvb3NlQ2xhc3MpOiBUIHtcbiAgY29uc3QgeyBtZXRhLCBpbnN0YW5jZSB9ID0gZ2V0QXJ0aWZhY3RzKG1vZGVsQ2xhc3MpO1xuICBjb25zdCBzdGF0aWNzID0ge307XG5cbiAgbWV0YS5zdGF0aWNzLmZvckVhY2goKHN0YXQ6IFtzdHJpbmcsIEZuXSB8IHN0cmluZykgPT4ge1xuICAgIGlmICh0eXBlb2Ygc3RhdFsxXSAhPT0gJ2Z1bmN0aW9uJykge1xuICAgICAgc3RhdGljc1s8c3RyaW5nPnN0YXRdID0gbW9kZWxDbGFzc1s8c3RyaW5nPnN0YXRdO1xuICAgIH1cbiAgfSk7XG5cbiAgY29uc3QgbmV3TW9kZWwgPSBNb25nb29zZU1vZGVsKG1ldGEubmFtZSwgYnVpbGRTY2hlbWEobWV0YSwgaW5zdGFuY2UpKTtcblxuICAvKipcbiAgICogRXh0ZW5kIG1vZGVsIHdpdGggc3RhdGljc1xuICAgKi9cbiAgZm9yIChsZXQga2V5IG9mIE9iamVjdC5rZXlzKHN0YXRpY3MpKSB7XG4gICAgbmV3TW9kZWxba2V5XSA9IHN0YXRpY3Nba2V5XTtcbiAgfVxuXG4gIHJldHVybiBuZXdNb2RlbCBhcyBhbnk7XG59XG5cbi8qKlxuICogQnVpbGQgc2NoZW1hXG4gKlxuICogQHBhcmFtIHtNb25nb29zZU1ldGF9IG1ldGFcbiAqIEBwYXJhbSB7YW55fSBjbGFzc0luc3RhbmNlXG4gKlxuICogQHJldHVybnMge1NjaGVtYX1cbiAqL1xuZnVuY3Rpb24gYnVpbGRTY2hlbWEobWV0YTogTW9uZ29vc2VNZXRhLCBjbGFzc0luc3RhbmNlKTogU2NoZW1hIHtcbiAgbGV0IG5ld1NjaGVtYTogU2NoZW1hID0gbmV3IFNjaGVtYShtZXRhLnNjaGVtYSk7XG4gIGxldCBpbmRleGVzID0ge307XG5cbiAgbWV0YS5zdGF0aWNzLmZvckVhY2goKHN0YXQ6IFtzdHJpbmcsIEZuXSB8IHN0cmluZykgPT4ge1xuICAgIGlmICh0eXBlb2Ygc3RhdFsxXSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgbmV3U2NoZW1hLnN0YXRpY3NbPHN0cmluZz5zdGF0WzBdXSA9IHdyYXBGdW5jdGlvbig8Rm4+c3RhdFsxXSwgY2xhc3NJbnN0YW5jZSk7XG4gICAgfVxuICB9KTtcblxuICBtZXRhLnF1ZXJpZXMuZm9yRWFjaCgoW25hbWUsIGZuXTogW3N0cmluZywgRm5dKSA9PiB7XG4gICAgbmV3U2NoZW1hWydxdWVyeSddW25hbWVdID0gd3JhcEZ1bmN0aW9uKGZuLCBjbGFzc0luc3RhbmNlKTtcbiAgfSk7XG5cbiAgbWV0YS5pbnN0YW5jZXMuZm9yRWFjaCgoW25hbWUsIGZuXTogW3N0cmluZywgRm5dKSA9PiB7XG4gICAgbmV3U2NoZW1hLm1ldGhvZHNbbmFtZV0gPSB3cmFwRnVuY3Rpb24oZm4sIGNsYXNzSW5zdGFuY2UpO1xuICB9KTtcblxuICBtZXRhLnZpcnR1YWxzLmZvckVhY2goKFtuYW1lLCBkZXNjcmlwdG9yXTogW3N0cmluZywgUHJvcGVydHlEZXNjcmlwdG9yXSkgPT4ge1xuICAgIGNvbnN0IHZpcnR1YWwgPSBuZXdTY2hlbWEudmlydHVhbChuYW1lKTtcblxuICAgIGlmIChkZXNjcmlwdG9yLmdldCkge1xuICAgICAgdmlydHVhbC5nZXQod3JhcEZ1bmN0aW9uKGRlc2NyaXB0b3IuZ2V0LCBjbGFzc0luc3RhbmNlKSk7XG4gICAgfVxuXG4gICAgaWYgKGRlc2NyaXB0b3Iuc2V0KSB7XG4gICAgICB2aXJ0dWFsLnNldCh3cmFwRnVuY3Rpb24oZGVzY3JpcHRvci5zZXQsIGNsYXNzSW5zdGFuY2UpKTtcbiAgICB9XG4gIH0pO1xuXG4gIG1ldGEuaW5kZXhlcy5mb3JFYWNoKChpbmRleDogc3RyaW5nKSA9PiB7XG4gICAgaW5kZXhlc1tpbmRleF0gPSBjbGFzc0luc3RhbmNlW2luZGV4XTtcbiAgICBuZXdTY2hlbWEuaW5kZXgoeyBbaW5kZXhdOiBjbGFzc0luc3RhbmNlW2luZGV4XSB9KTtcbiAgfSk7XG4gIC8vIG5ld1NjaGVtYS5pbmRleChpbmRleGVzKTtcblxuICBtZXRhLm9wdGlvbnMuZm9yRWFjaCgoW29wdGlvbiwgdmFsdWVdOiBbc3RyaW5nLCBhbnldKSA9PiB7XG4gICAgbmV3U2NoZW1hLnNldChvcHRpb24sIHZhbHVlKTtcbiAgfSk7XG5cbiAgbWV0YS5ob29rcy5mb3JFYWNoKChbaG9va1R5cGUsIGFjdGlvblR5cGUsIG5hbWVdOiBbc3RyaW5nLCBzdHJpbmcsIHN0cmluZ10pID0+IHtcbiAgICBuZXdTY2hlbWFbaG9va1R5cGVdKGFjdGlvblR5cGUsIGZ1bmN0aW9uKG5leHQpIHtcbiAgICAgIC8qKlxuICAgICAgICogSG9vayBleHBlY3RzIHRvIGdldCBleGFjdGx5IG9uZSBwYXJhbWV0ZXIsIHNvXG4gICAgICAgKiB3cmFwcGVkIGZ1bmN0aW9uIGNhbm5vdCBiZSBwYXNzZWQgYXMgYW4gYXJndW1lbnRcbiAgICAgICAqL1xuICAgICAgcmV0dXJuIHdyYXBGdW5jdGlvbihjbGFzc0luc3RhbmNlW25hbWVdLCBjbGFzc0luc3RhbmNlKS5jYWxsKHRoaXMsIG5leHQpO1xuICAgIH0pO1xuICB9KTtcblxuICByZXR1cm4gbmV3U2NoZW1hO1xufVxuXG4vKipcbiAqIFdyYXAgZnVuY3Rpb24gd2l0aCBjb3JyZWN0IGNvbnRleHQganVzdCB0byBtYWtlIHN1cmUsXG4gKiB0aGF0IGZ1bmN0aW9ucyB3aWxsIGJlIGV4ZWN1dGVkIHdpdGggc2NvcGUgb2YgY2xhc3NcbiAqIGluIG9yZGVyIHRvIGdldCBESSB3b3JraW5nIHByb3Blcmx5XG4gKlxuICogQHBhcmFtIHtGdW5jdGlvbn0gZm5cbiAqIEBwYXJhbSB7YW55fSBpbnN0YW5jZVxuICpcbiAqIEByZXR1cm5zIHtGdW5jdGlvbn1cbiAqL1xuZnVuY3Rpb24gd3JhcEZ1bmN0aW9uKGZuOiBGbiwgaW5zdGFuY2UpOiBGbiB7XG4gIHJldHVybiBmdW5jdGlvbihuZXh0KSB7XG4gICAgbGV0IGZ1bGxDdHggPSBpbnN0YW5jZTtcblxuICAgIGlmICh0aGlzKSB7XG4gICAgICBmdWxsQ3R4ID0geyAuLi5pbnN0YW5jZSwgLi4uKHRoaXMgfHwge30pIH07XG4gICAgICBPYmplY3Quc2V0UHJvdG90eXBlT2YoZnVsbEN0eCwgT2JqZWN0LmdldFByb3RvdHlwZU9mKHRoaXMpKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZm4uYXBwbHkoZnVsbEN0eCwgW25leHRdKTtcbiAgfTtcbn1cblxuLyoqXG4gKiBFeHRyYWN0IG1ldGEgYW5kIGNsYXNzSW5zdGFuY2Ugb2YgdGhlIGluamVjdGFibGVcbiAqXG4gKiBAcGFyYW0ge01vbmdvb3NlQ2xhc3N9IG1vZGVsQ2xhc3NcbiAqXG4gKiBAcmV0dXJucyB7eyBtZXRhOiBNb25nb29zZU1ldGEsIGluc3RhbmNlOiBNb25nb29zZUNsYXNzIH19XG4gKi9cbmZ1bmN0aW9uIGdldEFydGlmYWN0cyhtb2RlbENsYXNzOiBNb25nb29zZUNsYXNzKTogeyBtZXRhOiBNb25nb29zZU1ldGEsIGluc3RhbmNlOiBNb25nb29zZUNsYXNzIH0ge1xuICBjb25zdCBpbnN0YW5jZTogTW9uZ29vc2VDbGFzcyA9IGdldE1vZGVsKG1vZGVsQ2xhc3MpO1xuICBjb25zdCBtZXRhOiBNb25nb29zZU1ldGEgPSBnZXRNb25nb29zZU1ldGEoaW5zdGFuY2UpO1xuXG4gIHJldHVybiB7IG1ldGEsIGluc3RhbmNlIH07XG59XG5cbi8qKlxuICogR2V0IG1vZGVsIGluc3RhbmNlIGZyb20gY29udGFpbmVyIG9yIGluc3RhbnRpYXRlIG9uZVxuICpcbiAqIEBwYXJhbSB7TW9uZ29vc2VDbGFzc30gTW9kZWxDbGFzc1xuICpcbiAqIEByZXR1cm5zIHtNb25nb29zZUNsYXNzfVxuICovXG5mdW5jdGlvbiBnZXRNb2RlbChNb2RlbENsYXNzOiBNb25nb29zZUNsYXNzKTogTW9uZ29vc2VDbGFzcyB7XG4gIHRyeSB7XG4gICAgcmV0dXJuIENvbnRhaW5lci5nZXQoTW9kZWxDbGFzcyk7XG4gIH0gY2F0Y2gge1xuICAgIHJldHVybiBuZXcgTW9kZWxDbGFzcygpO1xuICB9XG59XG4iXX0=